<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Visual History Workbench</title>

    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/vis-history.css">
    <!--    <link rel="stylesheet" href="css/dashboard.css">-->
    <link rel="stylesheet" href="css/timeline-graph.css">


    <script type="text/javascript" src="js/jquery/jquery-3.3.1.js"></script>
    <script type="text/javascript" src="js/bootstrap.js"></script>
    <script type="text/javascript" src="js/d3.js"></script>
    <script type="text/javascript" src="js/vs-model.js"></script>
</head>

<body>

<nav class="navbar navbar-dark fixed-top bg-dark flex-md-nowrap p-0 shadow">
    <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="#">Visual History</a>
    <ul class="navbar-nav px-3">
        <li class="nav-item text-nowrap">
            <a class="nav-link" href="#">Sign out</a>
        </li>
    </ul>
</nav>

<div class="container-fluid h-100">
    <div class="row maxw">
        <nav class="col-md-2 d-none d-md-block bg-light sidebar">
            <div class="sidebar-sticky">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">
                            <span data-feather="home"></span>
                            Nawigacja<span class="sr-only">(current)</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="moveForward()">
                            <span data-feather="file"></span>
                            Do przodu
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="moveBackward()">
                            <span data-feather="shopping-cart"></span>
                            Do ty≈Çu
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <span data-feather="users"></span>
                            Customers
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <span data-feather="bar-chart-2"></span>
                            Reports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <span data-feather="layers"></span>
                            Integrations
                        </a>
                    </li>
                </ul>

                <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                    <span>Saved reports</span>
                    <a class="d-flex align-items-center text-muted" href="#">
                        <span data-feather="plus-circle"></span>
                    </a>
                </h6>
                <ul class="nav flex-column mb-2">
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <span data-feather="file-text"></span>
                            Current month
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <span data-feather="file-text"></span>
                            Last quarter
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <span data-feather="file-text"></span>
                            Social engagement
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <span data-feather="file-text"></span>
                            Year-end sale
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-4 h-100">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Dashboard</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group mr-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary">Share</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary">Export</button>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle">
                        <span data-feather="calendar"></span>
                        This week
                    </button>
                </div>
            </div>
            <div class="my-4 w-100" style="height: 90%">
                <svg id="myChart" width="100%" height="100%" style="border-style: solid; border-color:black">
                    <defs>
                        <filter id="shadow">
                            <feDropShadow dx="3" dy="3" stdDeviation="2"/>
                        </filter>
                    </defs>
                    <g id="lanes"></g>
                    <g id="mainGroup">
                        <g id="events"></g>
                    </g>
                    <line id="timeAxis" class="timeAxis"></line>
                </svg>
            </div>
            <!--            <h2>Text content</h2>-->
            <!--            <div id="entries"></div>-->
        </main>
    </div>
</div>

<script type="text/ecmascript">
    console.log("Script start...");

    window.viewport = {};

    viewport.width = 100;
    viewport.height = 100;
    viewport.axisPosition = 120;
    viewport.firstYear = 1910;
    viewport.datesExtent = [new Date("1916-01-01"), new Date("1939-12-31")];
    viewport.displayStartDate = new Date("1918-01-01");
    viewport.scaleOffset = 0;
    viewport.scale = d3.scaleTime();
    viewport.scaleOrig = d3.scaleTime();
    viewport.lanes = [{name: "Wydarzenia", x: 160, width: 250}];
    viewport.zoom = d3.zoom().scaleExtent([1, 10]);
    viewport.currentZoomLevel = 1;


    function initGraph() {
        //lanes
        var laneGroupSelection = d3.select("#lanes").selectAll("g.lane")
            .data(viewport.lanes)
            .enter()
            .append("g")
            .classed("lane", true);
        laneGroupSelection.append("rect").classed("lane", true).attr("x", function (lane) {
            return lane.x;
        }).attr("y", -5).attr("width", function (d) {
            return d.width;
        }).attr("height", viewport.height + 10);
        laneGroupSelection.append("text").attr("x", function (lane) {
            return lane.x + 10
        }).attr("y", 20).text(function (lane) {
            return lane.name;
        });


        console.log(viewport);
        viewport.scale = d3.scaleTime()
            .domain(viewport.datesExtent)
            .range([viewport.height, 0]);
        viewport.scaleOrig = d3.scaleTime()
            .domain(viewport.datesExtent)
            .range([viewport.height, 0]);

        // refreshTimeScale();
        updateGraphPosition();
        updateAxisLine();
        refreshTimeAxis();

        d3.select("#myChart").call(viewport.zoom.on("zoom", zoomEvent));
        loadDataCsv();
        // loadData();
    }

    function refreshGraphSize() {
        viewport.width = $('#myChart').width();
        viewport.height = $('#myChart').height();
        console.log("Refreshing size, w=" + viewport.width + " h=" + viewport.height);

        //update zoom:
        viewport.zoom.extent([[0, 0], [viewport.width, viewport.height]]);
        viewport.zoom.translateExtent([[0, 0], [viewport.width, viewport.height]]);
        updateAxisLine();
        refreshLanes();
    }


    function loadDataCsv() {
        d3.csv("data/dwudziestolecie.csv").then(function (data, error) {
            console.log("Loaded csv");
            console.log(data);
            var instances = data.map(HistoryEvent.buildFromCsv);
            console.log(instances);
            instances = instances.filter(ins => ins.isValid());
            console.log("After filter:");
            console.log(instances);
            updateEvents(instances);
            refreshEventView();
        });
    }


    function eventText(event) {
        return event.date + ": " + event.name;
    }

    function refreshEventView() {
        var lane = viewport.lanes[0];
        var itemSelection = d3.select("#events").selectAll("g.item");
        itemSelection
            .transition()
            .duration(100)
            .attr("transform", function (event) {
                var d = new Date(event.beginning());
                return "translate(" + (5 + lane.x) + ", " + viewport.scale(d) + ")";
            })
            .attr("visibility", function (event) {
                return event.visibleInZoom(Math.round(viewport.currentZoomLevel)) ? "visible" : "hidden";
            });

        const corner = 10;
        const xL = -(lane.x - viewport.axisPosition + 5);
        itemSelection.select("path")
            .transition()
            .duration(100)
            .attr("d", event => buildEventPath(event, xL, 0, corner));


    }

    //create events
    function updateEvents(items) {
        console.log("Adding items, will add " + items.length);
        // console.log(items);
        //rect with text:
        var itemSelection = d3.select("#events").selectAll("g.item").data(items, item => item.id);
        buildEventGroup(itemSelection.enter());
        itemSelection.exit().remove();

        console.log("Running wrap...");
        d3.select("#events")
            .selectAll("g.item")
            .each(wrapTextRect);


    }


    function eventPos(event) {
        return datePos(new Date(event.beginning()));
    }

    function datePos(date) {
        return viewport.scale(date);
    }

    function buildEventPath(event, x0, x1, extension) {
        let hline = `M ${x0} 0 L ${x1 + extension} 0`;
        if (event.isRange()) {
            console.log(`Event ${event.name} end: `, event.end());
            let dy = datePos(new Date(event.end())) - datePos(new Date(event.beginning()));
            if (dy > 5) {
                let xmed = (x0 + x1) / 2;
                let c = `M ${x1} 0 C ${xmed} 0 ${xmed} ${dy} ${x0} ${dy}`;
                return hline + " " + c;
            } else {
                return hline;
            }

        }
        return hline
    }

    function buildEventGroup(buildSelection) {
        const lane = viewport.lanes[0];
        var groupSelection = buildSelection.append("g")
            .classed("item", true)
            .attr("transform", function (event) {
                let yPos = eventPos(event);
                return "translate(" + (5 + lane.x) + ", " + yPos + ")";
            });
        const corner = 10;
        const xL = -(lane.x - viewport.axisPosition + 5);


        groupSelection.append("rect")
            .classed("item", true)
            .attr("width", lane.width - 10)
            .attr("height", 50)
            .attr("rx", corner)
            .attr("ry", corner)
        ;

        groupSelection.append("path")
            .attr("d", event => buildEventPath(event, xL, 0, corner));


        groupSelection
            .append("text")
            .attr("y", 20)
            .attr("x", 5)
            .text(function (event) {
                return event.name;
            });
    }


    $(window).resize(refreshGraphSize);

    window.addEventListener("load", function () {
        console.log("Onload.");
        setTimeout(refreshGraphSize, 1000);
        // refreshGraphSize();
        setTimeout(initGraph, 1100);
    });


    function refreshLanes() {
        d3.selectAll("g.lane").select("rect").attr("height", viewport.height + 10);
    }


    function updateGraphPosition() {

    }


    function refreshTimeAxis() {
        //test code:
        var years = [];
        for (var y = 1918; y < 1940; y++) {
            years.push(y);
        }
        // d3.selectAll(".timeAxisTick").data([]).remove();
        var buildTransformFunc = function (year) {
            return "translate(" + viewport.axisPosition + ", " + viewport.scale(new Date(year, 0, 1)) + ")";
        }
        var yearsSelection = d3.select("#mainGroup").selectAll(".timeAxisTick").data(years);
        yearsSelection.transition().duration(100).attr("transform", buildTransformFunc);

        var groups = yearsSelection.enter().append("g");
        groups.attr("transform", buildTransformFunc)
            .classed("timeAxisTick", true);
        groups.append("circle")
            .attr("r", 4);
        groups.append("text")
            .attr("text-anchor", "end")
            .attr("dx", "-10")
            .attr("dominant-baseline", "middle")
            .text(function (year) {
                return "" + year;
            });

        yearsSelection.exit().remove();
    }

    function updateAxisLine() {
        d3.select("#timeAxis")
            .attr("x1", viewport.axisPosition)
            .attr("y1", 0)
            .attr("x2", viewport.axisPosition)
            .attr("y2", viewport.height);
    }


    //event handling
    function moveForward() {
        // console.log("Moving forward...");
        viewport.displayStartDate.setDate(viewport.displayStartDate.getDate() + 100);
        // console.log(viewport.displayStartDate);
        updateGraphPosition();
    }

    function moveBackward() {
        // console.log("Moving backward...");
        viewport.displayStartDate.setDate(viewport.displayStartDate.getDate() - 100);
        // console.log(viewport.displayStartDate);
        updateGraphPosition();
    }

    function zoomEvent(event) {
        // console.log(d3.event.transform);
        var t = d3.event.transform;
        viewport.scale = t.rescaleY(viewport.scaleOrig);
        viewport.currentZoomLevel = t.k;
        // viewport.yearSize = Math.round(d3.event.transform.k);
        refreshTimeAxis();
        refreshEventView();

        //update event list:

    }


    function wrapTextRect(d, i) {
        var NS = "http://www.w3.org/2000/svg";
        // console.log("Applying text wrap...");
        // console.log(d);
        // console.log(i);
        //group selection:
        var groupSelection = d3.select(this);

        var myRect = groupSelection.select("rect").node();
        var myText = groupSelection.select("text").node();
        groupSelection.select("text").text("");

        var padding = 10
        var width = +myRect.getAttribute("width") - padding
        // var width=100;

        var x = +myRect.getAttribute("x")
        // var x = 10;
        var y = +myRect.getAttribute("y")
        // var y=10;
        var fontSize = 15;
        var text = d.name;

        var words = text.split(' ');
        var text_element = groupSelection.select("text").node();
        var tspan_element = document.createElementNS(NS, "tspan");   // Create first tspan element
        var text_node = document.createTextNode(words[0]);           // Create text in tspan element
        tspan_element.setAttribute("x", x + padding);
        tspan_element.setAttribute("y", y + padding + fontSize);
        tspan_element.appendChild(text_node);                           // Add tspan element to DOM
        text_element.appendChild(tspan_element);                        // Add text to tspan element

        for (var i = 1; i < words.length; i++) {
            var len = tspan_element.firstChild.data.length            // Find number of letters in string
            tspan_element.firstChild.data += " " + words[i];            // Add next word

            if (tspan_element.getComputedTextLength() > width - padding) {
                tspan_element.firstChild.data = tspan_element.firstChild.data.slice(0, len);    // Remove added word

                var tspan_element = document.createElementNS(NS, "tspan");       // Create new tspan element
                tspan_element.setAttribute("x", x + padding);
                tspan_element.setAttribute("dy", fontSize);
                text_node = document.createTextNode(words[i]);
                tspan_element.appendChild(text_node);
                text_element.appendChild(tspan_element);
            }
        }
        //
        var height = text_element.getBBox().height + 2 * padding; //-- get height plus padding
        myRect.setAttribute('height', height); //-- change rect height
        // showSourceSVG()
    }


</script>


</body>
</html>