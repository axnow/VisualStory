<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Visual History Workbench</title>

    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/vis-history.css">
    <!--    <link rel="stylesheet" href="css/dashboard.css">-->
    <link rel="stylesheet" href="css/timeline-graph.css">


    <script type="text/javascript" src="js/jquery/jquery-3.3.1.js"></script>
    <script type="text/javascript" src="js/bootstrap.js"></script>
    <script type="text/javascript" src="js/d3.js"></script>
</head>

<body>

<nav class="navbar navbar-dark fixed-top bg-dark flex-md-nowrap p-0 shadow">
    <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="#">Visual History</a>
    <ul class="navbar-nav px-3">
        <li class="nav-item text-nowrap">
            <a class="nav-link" href="#">Sign out</a>
        </li>
    </ul>
</nav>

<div class="container-fluid h-100">
    <div class="row maxw">
        <nav class="col-md-2 d-none d-md-block bg-light sidebar">
            <div class="sidebar-sticky">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">
                            <span data-feather="home"></span>
                            Nawigacja<span class="sr-only">(current)</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="moveForward()">
                            <span data-feather="file"></span>
                            Do przodu
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="moveBackward()">
                            <span data-feather="shopping-cart"></span>
                            Do tyłu
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <span data-feather="users"></span>
                            Customers
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <span data-feather="bar-chart-2"></span>
                            Reports
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <span data-feather="layers"></span>
                            Integrations
                        </a>
                    </li>
                </ul>

                <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                    <span>Saved reports</span>
                    <a class="d-flex align-items-center text-muted" href="#">
                        <span data-feather="plus-circle"></span>
                    </a>
                </h6>
                <ul class="nav flex-column mb-2">
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <span data-feather="file-text"></span>
                            Current month
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <span data-feather="file-text"></span>
                            Last quarter
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <span data-feather="file-text"></span>
                            Social engagement
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <span data-feather="file-text"></span>
                            Year-end sale
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-4 h-100">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Dashboard</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group mr-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary">Share</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary">Export</button>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle">
                        <span data-feather="calendar"></span>
                        This week
                    </button>
                </div>
            </div>
            <div class="my-4 w-100" style="height: 90%">
                <svg id="myChart" width="100%" height="100%" style="border-style: solid; border-color:black"></svg>
            </div>
            <!--            <h2>Text content</h2>-->
            <!--            <div id="entries"></div>-->
        </main>
    </div>
</div>

<script type="text/ecmascript">
    console.log("Script start...");

    window.viewport = {};

    viewport.width = 100;
    viewport.height = 100;
    viewport.axisPosition = 120;
    viewport.yearSize = 50;
    viewport.firstYear = 1918;
    viewport.displayStartDate = new Date("1918-01-01");
    viewport.scaleOffset = 0;
    viewport.scale = d3.scaleTime();

    console.log("Viewport state:");
    console.log(viewport);

    function refreshGraphSize() {
        viewport.width = $('#myChart').width();
        viewport.height = $('#myChart').height();
        console.log("Refreshig size, w=" + viewport.width + " h=" + viewport.height);
        // updateRect();
        updateAxisLine();
    }

    function loadData() {
        //d3js
        $.getJSON("data/events.json", function (data) {
            console.info("Got json, has size: " + data.length);
            // buildEventPars(data)
            updateItems(data)
        });
    }

    function eventText(event) {
        return event.date + ": " + event.name;
    }


    function updateItems(items) {
        console.log("Adding items:");
        console.log(items);
        //rect with text:
        d3.select("#myChart").append("g").attr("id", "events");
        var itemSelection = d3.select("#events").selectAll("g.item");
        itemSelection.data(items)
            .enter()
            .append("g")
            .classed("item", true)
            .attr("transform", function (event) {
                var d = new Date(event.date);
                console.log(d);
                return "translate(" + (50 + viewport.axisPosition) + ", " + viewport.scale(d) + ")";
            })
            .append("rect")
            .attr("width", 150)
            .attr("height", 50);
    }

    function buildEventPars(events) {
        // Update…
        var p = d3.select("#entries")
            .selectAll("p")
            .data(events)
            .text(function (d) {
                return eventText(d);
            });

// Enter…
        p.enter().append("p")
            .text(function (d) {
                return eventText(d);
            });

// Exit…
        p.exit().remove();
    }

    $(window).resize(refreshGraphSize);

    window.addEventListener("load", function () {
        console.log("Onload.");
        setTimeout(refreshGraphSize, 1000);
        // refreshGraphSize();
        setTimeout(initGraph, 1100);
    });

    function initGraph() {
        //build main group:
        d3.select("#myChart")
            .append("g")
            .attr("id", "mainGroup");
        //add axis line
        d3.select("#myChart")
            .append("line")
            .classed("timeAxis", true)
            .attr("id", "timeAxis");

        refreshTimeScale();
        updateGraphPosition();
        updateAxisLine();
        updateTimeAxis();

        var zoom = d3.zoom().scaleExtent([30, 150]);
        d3.select("#myChart").call(zoom.on("zoom", zoomEvent));
        loadData();
    }

    function refreshTimeScale() {
        console.log("Updating time scale")
        viewport.scale = d3.scaleTime()
            .domain([new Date(viewport.firstYear, 0, 1), new Date(viewport.firstYear + 1, 0, 1)])
            .range([0,  - viewport.yearSize]);
    }

    function updateGraphPosition() {
        d3.select("#mainGroup")
            .transition()
            .duration(1000)
            .attr("transform",
                "translate(0, " + (viewport.height - viewport.scale(viewport.displayStartDate)) + ")");
    }


    function updateTimeAxis() {
        refreshTimeScale();

        //test code:
        var years = [];
        for (var y = 1918; y < 1940; y++) {
            years.push(y);
        }
        // d3.selectAll(".timeAxisTick").data([]).remove();
        var yearsSelection = d3.select("#mainGroup").selectAll(".timeAxisTick").data(years);
        yearsSelection.transition(1000).attr("transform", function (year) {
            return "translate(" + viewport.axisPosition + ", " + viewport.scale(new Date(year, 0, 1)) + ")";
        });
        var groups = yearsSelection.enter().append("g");
        groups
            .attr("transform", function (year) {
                return "translate(" + viewport.axisPosition + ", " + viewport.scale(new Date(year, 0, 1)) + ")";
            })
            .classed("timeAxisTick", true);
        groups.append("circle")
            .attr("r", 4);
        groups.append("text")
            .attr("text-anchor", "end")
            .attr("dx", "-10")
            .attr("dominant-baseline", "middle")
            .text(function (year) {
                return "" + year;
            });

        yearsSelection.exit().remove();
    }

    function updateAxisLine() {
        d3.select("#timeAxis")
            .attr("x1", viewport.axisPosition)
            .attr("y1", 0)
            .attr("x2", viewport.axisPosition)
            .attr("y2", viewport.height);
    }


    function moveForward() {
        console.log("Moving forward...");
        viewport.displayStartDate.setDate(viewport.displayStartDate.getDate()+ 100);
        console.log(viewport.displayStartDate);
        updateGraphPosition();
    }

    function moveBackward() {
        console.log("Moving backward...");
        viewport.displayStartDate.setDate(viewport.displayStartDate.getDate()- 100);
        console.log(viewport.displayStartDate);
        updateGraphPosition();
    }

    function zoomEvent(event) {
        viewport.yearSize = Math.round(d3.event.transform.k);
        updateTimeAxis();
    }

</script>


</body>
</html>